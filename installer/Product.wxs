<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*" Name="SPYSCALP" Language="1033" Version="0.1.5" Manufacturer="SPYSCALP Developers" UpgradeCode="7d6c6a1e-8e9a-4f51-a1d2-b3c4d5e6f7a8">
        <Package InstallerVersion="200" Compressed="yes" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <!-- Dual Scope Properties & Variables -->
        <Property Id="ALLUSERS" Value="2" />
        <Property Id="MSIINSTALLPERUSER" Value="0" />
        <Property Id="WixAppFolder" Value="WixPerMachineFolder" />
        <WixVariable Id="WixUISupportPerUser" Value="1" />
        <WixVariable Id="WixUISupportPerMachine" Value="1" />
        <SetProperty Id="WixPerMachineFolder" Value="[ProgramFilesFolder]SPYSCALP" After="AppSearch" />
        <SetProperty Id="WixPerUserFolder" Value="[LocalAppDataFolder]SPYSCALP" After="AppSearch" />

        <Feature Id="ProductFeature" Title="SPYSCALP Main Application" Level="1">
            <ComponentRef Id="SpyscalpExe" />
            <ComponentGroupRef Id="LUpdateComponents" />
            <ComponentRef Id="ApplicationShortcut" />
            <ComponentRef Id="LUpdateShortcut" />
        </Feature>

        <!-- Icons -->
        <Icon Id="AppIcon" SourceFile="..\spyscalp.ico" />
        <Icon Id="LUpdateIcon" SourceFile="..\nuitka_dist\LUPDATE.ico" />
        <Binary Id="ChangeIcon" SourceFile="change.ico" />
        <Binary Id="RepairIcon" SourceFile="repair.ico" />
        <Binary Id="RemoveIcon" SourceFile="remove.ico" />
        <Binary Id="UpdateIcon" SourceFile="..\nuitka_dist\LUPDATE.ico" />
        <Property Id="ARPPRODUCTICON" Value="AppIcon" />

        <UI>
            <UIRef Id="WixUI_InstallDir" />
            <!-- Custom Maintenance Flow -->
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="CustomMaintenanceTypeDlg">1</Publish>
            <Publish Dialog="CustomMaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

            <!-- Inject InstallScopeDlg into the WixUI_InstallDir flow -->
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="InstallScopeDlg" Order="2">LicenseAccepted = "1"</Publish>
            <Publish Dialog="InstallScopeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg" Order="2">1</Publish>
            <Publish Dialog="InstallScopeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="InstallScopeDlg" Order="2">1</Publish>

            <!-- Update INSTALLFOLDER based on selection in InstallScopeDlg -->
            <Publish Dialog="InstallScopeDlg" Control="Next" Property="INSTALLFOLDER" Value="[WixPerUserFolder]" Order="3">WixAppFolder = "WixPerUserFolder"</Publish>
            <Publish Dialog="InstallScopeDlg" Control="Next" Property="INSTALLFOLDER" Value="[WixPerMachineFolder]" Order="3">WixAppFolder = "WixPerMachineFolder"</Publish>
        </UI>
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <WixVariable Id="WixUILicenseRtf" Value="EULA.rtf" />

        <!-- Launch Logic (Shared by ExitDialog and Maintenance) -->
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Run LiveUpdate now" />
        <CustomAction Id="SetWixShellExecTarget" Property="WixShellExecTarget" Value="[#LUPDATE.EXE]" />
        <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

        <!-- Directory Redirection for Per-User vs Per-Machine (Fallback for silent install) -->
        <SetDirectory Id="INSTALLFOLDER" Value="[WixPerUserFolder]" Sequence="both">MSIINSTALLPERUSER = 1</SetDirectory>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="SPYSCALP" />
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="SPYSCALP"/>
            </Directory>
        </Directory>

        <DirectoryRef Id="INSTALLFOLDER">
            <Component Id="SpyscalpExe" Guid="*">
                <File Id="SPYSCALP.EXE" Source="..\nuitka_dist\spyscalp.exe" KeyPath="yes" />
            </Component>
            <Component Id="LUpdateExe" Guid="*">
                <File Id="LUPDATE.EXE" Source="..\nuitka_dist\LUPDATE.exe" KeyPath="yes" />
            </Component>
            <Component Id="LUpdateConfig" Guid="*">
                <File Id="LUPDATE.CONF" Source="..\nuitka_dist\LUPDATE.conf" KeyPath="yes" />
            </Component>
        </DirectoryRef>

        <ComponentGroup Id="LUpdateComponents">
            <ComponentRef Id="LUpdateExe" />
            <ComponentRef Id="LUpdateConfig" />
        </ComponentGroup>

        <DirectoryRef Id="ApplicationProgramsFolder">
            <Component Id="ApplicationShortcut" Guid="*">
                <Shortcut Id="ApplicationStartMenuShortcut" 
                          Name="SPYSCALP" 
                          Description="Real-time SPY Options Scalping Logic" 
                          Target="[INSTALLFOLDER]spyscalp.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="AppIcon"
                          IconIndex="0"/>
                <Shortcut Id="CmdStartMenuShortcut"
                          Name="SPYSCALP Command Prompt"
                          Description="Open Command Prompt in SPYSCALP Directory"
                          Target="[SystemFolder]cmd.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="AppIcon"
                          IconIndex="0"/>
                <RemoveFolder Id="CleanUpShortCut" On="uninstall"/>
                <RegistryValue Root="HKCU" Key="Software\SPYSCALP" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
            <Component Id="LUpdateShortcut" Guid="*">
                <Shortcut Id="LUpdateStartMenuShortcut" 
                          Name="SPYSCALP LiveUpdate" 
                          Description="Check for software updates" 
                          Target="[INSTALLFOLDER]LUPDATE.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="LUpdateIcon"
                          IconIndex="0"/>
                <RegistryValue Root="HKCU" Key="Software\SPYSCALP" Name="lupdate_installed" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <!-- Trigger Launch on Exit (Post-Install) -->
        <UI>
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="SetWixShellExecTarget">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
        </UI>

    </Product>
</Wix>
